name: CI

on:
  push:
    branches: [main, dev]
    tags:
      - "v*"
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to (re)publish release assets for (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test | ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            glue/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run unit tests
        run: cargo test --workspace --exclude cli
        working-directory: glue

      - name: Run CLI unit tests (skip E2E)
        run: cargo test -p cli --lib
        working-directory: glue

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            glue/target
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}

      - uses: j178/prek-action@v1

  e2e-tests:
    name: E2E tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            glue/target
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Run E2E tests
        run: just test-e2e-cli
        working-directory: .

  perf-codegen-gate:
    name: Perf | Codegen regression gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    env:
      PERF_REGRESSION_THRESHOLD_PCT: "20"
      PERF_APPROVAL_LABEL: "perf-regression-approved"
      GLUE_BENCH_ITERATIONS: "10"
      GLUE_BENCH_WARMUPS: "3"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            glue/target
          key: ${{ runner.os }}-cargo-perf-${{ hashFiles('**/Cargo.lock') }}

      - name: Measure HEAD codegen perf
        run: |
          cd glue
          GLUE_BENCH_JSON_OUT="$RUNNER_TEMP/head_perf.json" cargo bench -p cli --bench codegen_perf

      - name: Check out PR base in worktree
        run: |
          git fetch --no-tags origin ${{ github.event.pull_request.base.sha }} --depth=1
          git worktree add "$RUNNER_TEMP/base_checkout" ${{ github.event.pull_request.base.sha }}

      - name: Measure baseline codegen perf
        run: |
          cd "$RUNNER_TEMP/base_checkout/glue"
          GLUE_BENCH_JSON_OUT="$RUNNER_TEMP/base_perf.json" cargo bench -p cli --bench codegen_perf

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compare perf and enforce approval gate
        run: |
          set -euo pipefail
          base_ms=$(jq -r '.median_ms' "$RUNNER_TEMP/base_perf.json")
          head_ms=$(jq -r '.median_ms' "$RUNNER_TEMP/head_perf.json")
          threshold_pct=${PERF_REGRESSION_THRESHOLD_PCT}
          regression_pct=$(awk -v h="$head_ms" -v b="$base_ms" 'BEGIN { if (b <= 0) { print "nan" } else { printf "%.6f", ((h-b)/b)*100 } }')

          if [ "$regression_pct" = "nan" ]; then
            echo "::error::Invalid baseline median_ms ($base_ms), cannot compare perf"
            exit 1
          fi

          echo "Base median: ${base_ms} ms"
          echo "Head median: ${head_ms} ms"
          echo "Regression: ${regression_pct}% (threshold ${threshold_pct}%)"

          within_threshold=$(awk -v r="$regression_pct" -v t="$threshold_pct" 'BEGIN { if (r <= t) print "yes"; else print "no" }')
          if [ "$within_threshold" = "yes" ]; then
            echo "Perf gate passed"
            exit 0
          fi

          has_approval=$(jq -r --arg label "$PERF_APPROVAL_LABEL" '(.pull_request.labels // []) | map(.name) | any(. == $label)' "$GITHUB_EVENT_PATH")
          if [ "$has_approval" = "true" ]; then
            echo "::warning::Perf regression above threshold, but '$PERF_APPROVAL_LABEL' label is present. Gate overridden."
            exit 0
          fi

          echo "::error::Codegen perf regression ${regression_pct}% exceeds ${threshold_pct}% without approval label '$PERF_APPROVAL_LABEL'."
          exit 1

      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codegen-perf-results
          path: |
            ${{ runner.temp }}/base_perf.json
            ${{ runner.temp }}/head_perf.json
          if-no-files-found: ignore

      - name: Cleanup worktree
        if: always()
        run: git worktree remove "$RUNNER_TEMP/base_checkout" --force || true

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    env:
      COVERAGE_THRESHOLD: "60"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            glue/target
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Run tests with coverage
        run: just codecov
        working-directory: .

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: glue/lcov.info
          if-no-files-found: error

  extension-test:
    name: VS Code Extension Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            glue/target
          key: ${{ runner.os }}-cargo-ext-${{ hashFiles('**/Cargo.lock') }}

      - name: Install extension dependencies
        run: npm ci
        working-directory: extension

      - name: Build extension and LSP
        run: |
          npm run compile
          npm run build:lsp
        working-directory: extension

      - name: Run extension tests
        run: xvfb-run -a npm test
        working-directory: extension

  extension:
    name: VS Code extension | ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: [test, lint, extension-test, coverage]
    if: startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: darwin-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: win32-x64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            platform: win32-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: |
          npm ci
          npm install -g @vscode/vsce
        working-directory: extension

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Build LSP
        run: cargo build --release --bin lsp --target ${{ matrix.target }}
        working-directory: glue
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Copy LSP binary to extension (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p out
          cp ../glue/target/${{ matrix.target }}/release/lsp out/lsp
          chmod +x out/lsp
        working-directory: extension

      - name: Copy LSP binary to extension (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path out
          Copy-Item "../glue/target/${{ matrix.target }}/release/lsp.exe" -Destination "out/lsp.exe"
        working-directory: extension

      - name: Compile extension
        run: npm run compile
        working-directory: extension

      - name: Publish to VS Code Marketplace
        run: vsce publish --pat ${{ secrets.VS_CODE_EXTENSION_PUBLISH_PAT }} --target ${{ matrix.platform }}
        working-directory: extension

  extension-vsix:
    name: VS Code VSIX | ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: [test, lint, extension-test, coverage]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || github.ref_name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: darwin-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: win32-x64
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            platform: win32-arm64
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: |
          npm ci
          npm install -g @vscode/vsce
        working-directory: extension

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Build LSP
        run: cargo build --release --bin lsp --target ${{ matrix.target }}
        working-directory: glue
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Copy LSP binary to extension (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p out
          cp ../glue/target/${{ matrix.target }}/release/lsp out/lsp
          chmod +x out/lsp
        working-directory: extension

      - name: Copy LSP binary to extension (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path out
          Copy-Item "../glue/target/${{ matrix.target }}/release/lsp.exe" -Destination "out/lsp.exe"
        working-directory: extension

      - name: Compile extension
        run: npm run compile
        working-directory: extension

      - name: Package VSIX
        shell: bash
        run: |
          mkdir -p ../artifacts
          vsce package --target "${{ matrix.platform }}" --out "../artifacts/glue_${{ matrix.platform }}.vsix"
        working-directory: extension

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-${{ matrix.platform }}
          path: artifacts/*.vsix
          if-no-files-found: error

  build-artifacts:
    name: Build | ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: [test, lint, e2e-tests, coverage]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || github.ref_name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: glue_linux_amd64
            binary_extension: ""
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: glue_linux_arm64
            binary_extension: ""
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: glue_darwin_amd64
            binary_extension: ""
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: glue_darwin_arm64
            binary_extension: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: glue_windows_amd64
            binary_extension: ".exe"
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            artifact_name: glue_windows_arm64
            binary_extension: ".exe"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            glue/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }} --workspace
        working-directory: glue
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Prepare artifact directory
        shell: bash
        run: |
          mkdir -p artifacts
          cp glue/target/${{ matrix.target }}/release/glue${{ matrix.binary_extension }} artifacts/glue${{ matrix.binary_extension }}
          cp glue/target/${{ matrix.target }}/release/lang${{ matrix.binary_extension }} artifacts/lang${{ matrix.binary_extension }}
          cp glue/target/${{ matrix.target }}/release/lsp${{ matrix.binary_extension }} artifacts/lsp${{ matrix.binary_extension }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/*
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-artifacts, extension-vsix]
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || github.ref_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release assets
        shell: bash
        run: |
          mkdir -p dist

          # Binary artifacts: tar up only directories that contain a glue binary.
          for dir in artifacts/*/; do
            name="$(basename "$dir")"
            if [ -f "${dir}glue" ] || [ -f "${dir}glue.exe" ]; then
              tar -czvf "dist/${name}.tar.gz" -C "$dir" .
            fi
          done

          # VSIX artifacts: copy through as-is.
          find artifacts -maxdepth 3 -type f -name '*.vsix' -print -exec cp {} dist/ \;

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            dist/*.tar.gz
            dist/*.vsix
            install.sh
            install.ps1
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}